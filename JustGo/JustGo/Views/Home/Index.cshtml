@model IEnumerable<Place>
@{
    ViewData["Title"] = "Home Page";
}

<div class="text-center">
        <div id="app">
        <!-- v-for 產生行程天數  -->
        
    </div>

@*    <div id="app2">
        <button @@click="axios">click</button>
        {{travel}}
    </div>*@
</div>

@section Scripts{
    <script src="https://unpkg.com/axios/dist/axios.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.6.14/dist/vue.js"></script>
    <script src="https://unpkg.com/vuex@3"></script>
    <script src="https://www.itxst.com/package/sortable/Sortable.min.js"></script>
    <script src="https://www.itxst.com/package/vuedraggable/vuedraggable.umd.min.js"></script>
    

    <script>

        //const store = new Vuex.Store({
        //    state: {
        //            travel: []
        //            },
        //    mutations: {
        //        updateData(state, status) {
        //            state.travel = status
        //        }
            
        //    },
        //    getters: {},
        //    actions: {
        //        axiosTest(context,status){
        //            axios.get("@Url.Action("teatMapData","Home")")
        //            .then(res => context.commit('updateData',status))
        //            .catch(err => console.log("err"))
        //            }
        //        }
        //})
        
        //Vue.component('vuedraggable', window.vuedraggable.name)

        //new Vue({
        //    store,
        //    el:'#app2',
        //    methods: {           
        //    },
        //    components: {vuedraggable},
        //    data() {
        //        return {
        //            drag: true,
        //        }
        //    },
        //    computed: {
        //        travel() {
        //            return this.$store.state.travel
        //        }
        //    },
        //    mounted(){
        //        this.$store.dispatch('axiosTest')
        //        //console.log("hi")
        //    }
        //})



        let id = 0;
        Vue.component('vuedraggable', window.vuedraggable.name)
        var app = new Vue({
            el: '#app',
            data: {
            },
            components: {
                vuedraggable,
            },
            data() {
                return {
                    drag: true,
                    datetime: ['09:00', '09:00'],
                    travel: [
                        [
                            { id: id++, address: '高雄市桃源區拉芙蘭里拉芙蘭路20號', view: '拉芙蘭藝術村', min: 60, starttime: '9:00', endtime: '10:00' },
                            { id: id++, address: '高雄市桃源區寶山里寶山巷150號', view: '藤枝國家森林遊樂區', min: 90, starttime: '10:00', endtime: '11:30' }
                        ],

                        [
                            { id: id++, address: '高雄市桃源區梅山村三鄰梅山巷44之5號', view: '布農文化展示中心', min: 60, starttime: '9:00', endtime: '10:00' },
                            { id: id++, address: '高雄市桃源區南進巷180號', view: '桃源區原住民文物館', min: 90, starttime: '10:00', endtime: '11:30' }
                        ]
                    ],

                    selectPlaces: []
                };

            },
            mounted() {
                axios.get("@Url.Action("teatMapData","Home")")
                    .then(res => this.selectPlaces = (res.data))
                    .catch(err => console.log("err"))
            },
            methods: {
                // 新增景點
                addview: function(index) {
                    this.travel[0].push({ address: this.selectPlaces[index].add, view: this.selectPlaces[index].name, min: this.selectPlaces[index].timestay })
                    this.cultime(index)
                },
                //刪除景點
                remove: function(day, view) {
                    this.travel[day].splice(view, 1)
                    this.cultime(day)
                },
                //編排時間
                cultime(dayIndex) {
                    for (let j = 0; j < this.travel.length; j++) {
                        let timestamp = this.datetime[j]
                        for (let i = 0; i < this.travel[j].length; i++) {
                            this.travel[j][i].starttime = timestamp
                            let hr = timestamp.substring(0, 2)
                            let min = timestamp.substring(3, 5)
                            let addhr = parseInt((Number(min) + Number(this.travel[j][i].min)) / 60)

                            hr = Number(hr) + Number(addhr)
                            min = (Number(min) + Number(this.travel[j][i].min)) % 60

                            if (hr < 10) {
                                hr = '0' + hr
                            }
                            if (min < 10) {
                                min = '0' + min
                            }
                            timestamp = hr + ':' + min
                            this.travel[j][i].endtime = timestamp
                        }
                    }
                },

                //拖曳啟動
                onStart() {
                    this.drag = true;
                },
                //拖曳結束
                onEnd() {
                    this.drag = false;
                }
            },
            template: 
            `

             <div>
                <div class="itxst">
                    <div class="col" v-for="(day,dayIndex) in travel">
                        <div class="title"></div>
                <!-- v-for 產生當天行程細項  -->
                Day{{dayIndex+1}}
                <hr>
                旅遊時間:<input type="time" v-model="datetime[dayIndex]" @@change="cultime(dayIndex)">
                <draggable v-model="travel[dayIndex]" group="site" animation="300" dragClass="dragClass"
                    ghostClass="ghostClass" chosenClass="chosenClass" @@start="onStart" @@end="onEnd"
                    @@change="cultime(dayIndex)" class="min">
                    <transition-group>
                        <div class="item" v-for="(view,veiwIndex) in day" :key="view">
                            {{view.starttime}}-{{view.endtime}}<br>
                            地址:{{view.address}}<br>
                            景點:{{view.view}}<br>
                            <button @@click="remove(dayIndex,veiwIndex)">remove</button>
                        </div>                     
                    </transition-group>
                    </draggable>              
                    </div>
                </div>
                <!-- *測試*新增景點 -->
                <div class="itxst">
                    <div class="col">
                        <div class="title">Search</div>
                            <div v-for="(view,selIndex) in selectPlaces">
                                <div class="item" v-model="view" >
                                <h2>{{view.name}}</h2>
                                    {{view.description}}<br><br>
                                    電話:{{view.tel}}<br><br>
                                    地址:{{view.add}}<br><br>
                                    營業時間:{{view.opentime}}-{{view.closetime}}<br><br>
                                    建議停留:{{view.timestay}}分鐘<br>
                                <div>
                                <button @@click="addview(selIndex)">新增至行程</button>
                            </div>
                        </div>
                    </div>
                </div>
            `
        });
    </script>
    }
